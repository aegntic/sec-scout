import React, { useState } from 'react';
import { 
  Card, 
  CardContent, 
  Typography, 
  Chip, 
  IconButton, 
  Collapse,
  Box,
  Link,
  Divider,
  Grid,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableRow,
  Paper
} from '@mui/material';
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import BugReportIcon from '@mui/icons-material/BugReport';
import SecurityIcon from '@mui/icons-material/Security';
import LockOpenIcon from '@mui/icons-material/LockOpen';
import InfoIcon from '@mui/icons-material/Info';
import CodeIcon from '@mui/icons-material/Code';
import { styled } from '@mui/material/styles';
import SyntaxHighlighter from 'react-syntax-highlighter';
import { vs2015 } from 'react-syntax-highlighter/dist/esm/styles/hljs';

const ExpandMore = styled((props) => {
  const { expand, ...other } = props;
  return <IconButton {...other} />;
})(({ theme, expand }) => ({
  transform: !expand ? 'rotate(0deg)' : 'rotate(180deg)',
  marginLeft: 'auto',
  transition: theme.transitions.create('transform', {
    duration: theme.transitions.duration.shortest,
  }),
}));

const severityColors = {
  critical: '#e74c3c',
  high: '#e67e22',
  medium: '#f39c12',
  low: '#3498db',
  info: '#95a5a6'
};

const VulnerabilityCard = ({ finding }) => {
  const [expanded, setExpanded] = useState(false);

  const handleExpandClick = () => {
    setExpanded(!expanded);
  };

  const getSeverityIcon = (severity) => {
    switch (severity.toLowerCase()) {
      case 'critical':
      case 'high':
        return <LockOpenIcon />;
      case 'medium':
        return <BugReportIcon />;
      case 'low':
        return <SecurityIcon />;
      default:
        return <InfoIcon />;
    }
  };

  return (
    <Card 
      className={`finding-card ${finding.severity.toLowerCase()}`}
      sx={{ 
        mb: 2, 
        borderLeft: `4px solid ${severityColors[finding.severity.toLowerCase()] || severityColors.info}` 
      }}
    >
      <CardContent sx={{ pb: 0 }}>
        <Grid container alignItems="center" spacing={2}>
          <Grid item>
            <Box sx={{ color: severityColors[finding.severity.toLowerCase()] || severityColors.info }}>
              {getSeverityIcon(finding.severity)}
            </Box>
          </Grid>
          <Grid item xs>
            <Typography variant="h6" component="div">
              {finding.title}
            </Typography>
            <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
              {finding.description}
            </Typography>
          </Grid>
          <Grid item>
            <Chip 
              label={finding.severity} 
              sx={{ 
                backgroundColor: severityColors[finding.severity.toLowerCase()] || severityColors.info,
                color: 'white',
                fontWeight: 'bold'
              }} 
            />
          </Grid>
          <Grid item>
            <ExpandMore
              expand={expanded}
              onClick={handleExpandClick}
              aria-expanded={expanded}
              aria-label="show more"
            >
              <ExpandMoreIcon />
            </ExpandMore>
          </Grid>
        </Grid>
      </CardContent>
      <Collapse in={expanded} timeout="auto" unmountOnExit>
        <CardContent>
          <Divider sx={{ my: 2 }} />
          
          <Typography variant="subtitle1" gutterBottom sx={{ fontWeight: 'bold' }}>
            Vulnerability Details
          </Typography>
          
          <TableContainer component={Paper} variant="outlined" sx={{ mb: 3 }}>
            <Table size="small">
              <TableBody>
                <TableRow>
                  <TableCell component="th" scope="row" sx={{ fontWeight: 'bold', width: '30%' }}>
                    Category
                  </TableCell>
                  <TableCell>{finding.category}</TableCell>
                </TableRow>
                <TableRow>
                  <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                    CVSS Score
                  </TableCell>
                  <TableCell>{finding.cvss || 'N/A'}</TableCell>
                </TableRow>
                <TableRow>
                  <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                    Location
                  </TableCell>
                  <TableCell>{finding.location || 'N/A'}</TableCell>
                </TableRow>
                {finding.cwe && (
                  <TableRow>
                    <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                      CWE
                    </TableCell>
                    <TableCell>
                      <Link href={`https://cwe.mitre.org/data/definitions/${finding.cwe}.html`} target="_blank">
                        CWE-{finding.cwe}
                      </Link>
                    </TableCell>
                  </TableRow>
                )}
                <TableRow>
                  <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                    Detection Method
                  </TableCell>
                  <TableCell>{finding.detectionMethod || 'Automated Analysis'}</TableCell>
                </TableRow>
              </TableBody>
            </Table>
          </TableContainer>

          {finding.evidence && (
            <>
              <Typography variant="subtitle1" gutterBottom sx={{ fontWeight: 'bold', display: 'flex', alignItems: 'center' }}>
                <CodeIcon sx={{ mr: 1 }} /> Evidence
              </Typography>
              <Box sx={{ mb: 3 }}>
                <SyntaxHighlighter
                  language={finding.evidenceType || 'javascript'}
                  style={vs2015}
                  customStyle={{ borderRadius: '4px' }}
                >
                  {finding.evidence}
                </SyntaxHighlighter>
              </Box>
            </>
          )}

          <Typography variant="subtitle1" gutterBottom sx={{ fontWeight: 'bold' }}>
            Impact
          </Typography>
          <Typography variant="body2" paragraph>
            {finding.impact || 'No impact information available.'}
          </Typography>

          <Typography variant="subtitle1" gutterBottom sx={{ fontWeight: 'bold' }}>
            Recommendation
          </Typography>
          <Typography variant="body2" paragraph>
            {finding.recommendation || 'No recommendation available.'}
          </Typography>

          {finding.references && finding.references.length > 0 && (
            <>
              <Typography variant="subtitle1" gutterBottom sx={{ fontWeight: 'bold' }}>
                References
              </Typography>
              <ul>
                {finding.references.map((ref, index) => (
                  <li key={index}>
                    <Link href={ref.url} target="_blank">
                      {ref.title || ref.url}
                    </Link>
                  </li>
                ))}
              </ul>
            </>
          )}
        </CardContent>
      </Collapse>
    </Card>
  );
};

export default VulnerabilityCard;